/* ===================================================
 * tagmanager.js v3.0.0
 * http://welldonethings.com/tags/manager
 * ===================================================
 * Copyright 2012 Max Favilli
 *
 * Licensed under the Mozilla Public License, Version 2.0 You may not use this work except in compliance with the License.
 *
 * http://www.mozilla.org/MPL/2.0/
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================== */
 !function(a){"use strict";("undefined"==typeof console||"undefined"==typeof console.log)&&(console={},console.log=function(){}),a.fn.tagsManager=function(b,c){var d=this,e="",f={prefilled:null,CapitalizeFirstLetter:!1,preventSubmitOnEnter:!0,isClearInputOnEsc:!0,AjaxPush:null,AjaxPushAllTags:null,AjaxPushParameters:null,delimiters:[9,13,44],backspace:[8],maxTags:0,hiddenTagListName:null,hiddenTagListId:null,replace:!0,output:null,deleteTagsOnBackspace:!0,tagsContainer:null,tagCloseIcon:"x",tagClass:"",validator:null,onlyTagList:!1};if(!(0 in this))return this;if("string"==typeof b?f=d.data("tm_options"):(a.extend(f,b),d.data("tm_options",f)),"string"==typeof b)e=d.data("tm_rndid");else{for(var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",h=0;5>h;h++)e+=g.charAt(Math.floor(Math.random()*g.length));d.data("tm_rndid",e)}if(f.replace===!0&&null===f.hiddenTagListName){var i=d.attr("name");f.hiddenTagListName=i,d.attr("name","display-"+e)}null===f.hiddenTagListName&&(f.hiddenTagListName="hidden-"+e);var j=f.delimeters||f.delimiters,k=[9,13,17,18,19,37,38,39,40],l=[],m=[];a.each(j,function(b,c){-1!=a.inArray(c,k)?m.push(c):l.push(c)});var n=String.fromCharCode(l[0]||44),o=f.backspace,p="tm-tag",q="tm-input";a.isFunction(f.validator)&&d.data("validator",f.validator);var r=function(){var b=p;return d.attr("class")&&a.each(d.attr("class").split(" "),function(a,c){-1!=c.indexOf(q+"-")&&(b+=" "+p+c.substring(q.length))}),b+=f.tagClass?" "+f.tagClass:""},s=function(b){b=a.trim(b);var c=0;for(c;c<b.length&&-1==a.inArray(b.charCodeAt(c),l);c++);return b.substring(0,c)},t=function(){var a=d.data("tlis");f.maxTags>0&&a.length<f.maxTags&&(d.show(),d.trigger("tm:show")),f.maxTags>0&&a.length>=f.maxTags&&(d.hide(),d.trigger("tm:hide"))},u=function(){var b=d.data("tlis"),c=d.data("tlid");if(c.length>0){var f=c.pop(),g=b[b.length-1];d.trigger("tm:popping",g),b.pop(),a("#"+e+"_"+f).remove(),w(),d.trigger("tm:popped",g)}t()},v=function(){for(var b=d.data("tlis"),c=d.data("tlid");c.length>0;){var f=c.pop();b.pop(),a("#"+e+"_"+f).remove(),w()}d.trigger("tm:emptied",null),t()},w=function(){var b=d.data("tlis"),c=d.data("lhiddenTagList");c&&a(c).val(b.join(n)).change(),d.trigger("tm:refresh",b.join(n))},x=function(b){var c=d.data("tlis"),f=d.data("tlid"),g=a.inArray(b,f);if(-1!=g){var h=c[g];d.trigger("tm:splicing",h),a("#"+e+"_"+b).remove(),c.splice(g,1),f.splice(g,1),w(),d.trigger("tm:spliced",h)}t()},y=function(b,c){if(f.AjaxPushAllTags&&("tm:pushed"!=b.type||-1==a.inArray(c,f.prefilled))){var e=d.data("tlis");a.post(f.AjaxPush,{tags:e.join(n)})}},z=function(b,c){if(b=s(b),b&&!(b.length<=0)&&(f.CapitalizeFirstLetter&&b.length>1&&(b=b.charAt(0).toUpperCase()+b.slice(1).toLowerCase()),!d.data("validator")||d.data("validator")(b))){var g=d.data("tlis"),h=d.data("tlid");if(!(f.maxTags>0&&g.length>=f.maxTags)){var i=!1,j=g.map(function(a){return a.toLowerCase()}),k=a.inArray(b.toLowerCase(),j);if(-1!=k&&(i=!0),i){var l=h[k];a("#"+e+"_"+l).stop().animate({backgroundColor:f.blinkBGColor_1},100).animate({backgroundColor:f.blinkBGColor_2},100).animate({backgroundColor:f.blinkBGColor_1},100).animate({backgroundColor:f.blinkBGColor_2},100).animate({backgroundColor:f.blinkBGColor_1},100).animate({backgroundColor:f.blinkBGColor_2},100)}else{c||d.trigger("tm:pushing",b);var m=Math.max.apply(null,h);m=m==-1/0?0:m;var n=++m;g.push(b),h.push(n),c||null!=f.AjaxPush&&-1==a.inArray(b,f.prefilled)&&a.post(f.AjaxPush,a.extend({tag:b},f.AjaxPushParameters));var o=e+"_"+n,p=e+"_Remover_"+n,q=a("<span></span>").text(b).html(),u='<span class="'+r()+'" id="'+o+'">';u+="<span>"+q+"</span>",u+='<a href="#" class="tm-tag-remove" id="'+p+'" TagIdToRemove="'+n+'">',u+=f.tagCloseIcon+"</a></span> ";var v=a(u);if(null!=f.tagsContainer)a(f.tagsContainer).append(v);else if(n>1){var y=n-1,z=a("#"+e+"_"+y);z.after(v)}else d.before(v);v.find("#"+p).on("click",d,function(b){b.preventDefault();var c=parseInt(a(this).attr("TagIdToRemove"));x(c,b.data)}),w(),c||d.trigger("tm:pushed",b),t()}d.val("")}}},A=function(b){a.each(b,function(a,b){z(b,!0)})},B=function(a){a.cancelBubble=!0,a.returnValue=!1,a.stopPropagation(),a.preventDefault()},C=function(b,c){return-1!=a.inArray(b.which,c)},D=function(a){z(d.val()),a.preventDefault()},E=null;return this.each(function(){if("string"!=typeof b){if(a(this).data("tagManager"))return!1;a(this).data("tagManager",!0);var e=new Array,g=new Array;if(d.data("tlis",e),d.data("tlid",g),null==f.output){var h=jQuery("<input/>",{type:"hidden",name:f.hiddenTagListName});d.after(h),d.data("lhiddenTagList",h)}else d.data("lhiddenTagList",jQuery(f.output));f.AjaxPushAllTags&&(d.on("tm:spliced",y),d.on("tm:popped",y),d.on("tm:pushed",y)),d.on("focus keypress",function(){a(this).popover&&a(this).popover("hide")}),f.isClearInputOnEsc&&d.on("keyup",function(b){27==b.which&&(a(this).val(""),B(b))}),d.on("keypress",function(a){C(a,l)&&D(a)}),d.on("keydown",function(a){13==a.which&&f.preventSubmitOnEnter&&B(a),C(a,m)&&D(a)}),f.deleteTagsOnBackspace&&d.on("keydown",function(b){C(b,o)&&a(this).val().length<=0&&(u(),B(b))}),d.change(function(b){/webkit/.test(navigator.userAgent.toLowerCase())||a(this).focus(),B(b)}),null!=f.prefilled?"object"==typeof f.prefilled?A(f.prefilled):"string"==typeof f.prefilled?A(f.prefilled.split(n)):"function"==typeof f.prefilled&&A(f.prefilled()):null!=f.output&&(jQuery(f.output)&&jQuery(f.output).val()&&jQuery(f.output),A(jQuery(f.output).val().split(n)))}else switch(b){case"empty":v();break;case"popTag":u();break;case"pushTag":z(c);break;case"tags":E={tags:d.data("tlis")}}}),E||(E=this),E}}(jQuery);